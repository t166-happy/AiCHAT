<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>書籍推薦（馬卡龍配色｜兩本一頁｜可儲存雲端）</title>
<style>
  :root{
    /* 馬卡龍色板 */
    --mint: #b8e1d9;
    --peach: #ffd8cc;
    --lavender: #e6d6ff;
    --lemon: #fff4b8;
    --sky: #cfe9ff;
    --ink: #2e2e2e;
    --muted: #666;
    --card-bg: #ffffffcc;
    --radius: 16px;
    --gap: 16px;
  }
  body{
    font-family: system-ui, -apple-system, "Noto Sans TC", Roboto, Arial;
    margin: 0; color: var(--ink);
    background:
      radial-gradient(1200px 600px at -10% -10%, var(--mint), transparent 60%),
      radial-gradient(1000px 600px at 110% 0%, var(--peach), transparent 60%),
      radial-gradient(900px 600px at 50% 120%, var(--lavender), transparent 60%),
      #fdfdfd;
    min-height: 100vh;
  }
  header{
    padding: 24px 20px;
    backdrop-filter: blur(6px);
  }
  h1{ margin: 0 0 12px; font-size: 24px; }
  .bar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  input, select, button, textarea{
    font: inherit;
    padding: 10px 12px; border-radius: 999px; border: 1px solid #ddd; background: #fff;
  }
  input[type="text"]{ min-width: 260px; }
  button{
    cursor: pointer; border: none; color: #222;
    background: linear-gradient(135deg, var(--lemon), var(--sky));
  }
  button:hover{ filter: brightness(0.98); }
  .chip{ display:inline-block; padding:4px 10px; border-radius:999px; background:#fff; border:1px solid #eee; color: var(--muted); font-size:12px; }

  .container{ padding: 0 20px 32px; max-width: 1080px; margin: 0 auto; }
  .notice{ margin: 12px 0; padding: 10px 14px; background: #ffffffaa; border:1px solid #eee; border-radius: var(--radius); }
  .grid{
    margin-top: 12px;
    display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap);
  }
  @media (max-width: 820px){ .grid{ grid-template-columns: 1fr; } }
  .card{
    display:grid; grid-template-columns: 140px 1fr; gap: var(--gap);
    background: var(--card-bg); border:1px solid #eee; border-radius: var(--radius);
    box-shadow: 0 8px 20px rgba(0,0,0,.06);
    padding: 14px;
    backdrop-filter: blur(4px);
  }
  .cover{ width:140px; height:200px; object-fit:cover; border-radius: 12px; background:#f3f3f3; }
  .title{ margin: 0 0 6px; font-size: 20px; }
  .meta{ margin: 2px 0; color: var(--muted); font-size: 14px; }
  .desc{ margin-top: 6px; line-height: 1.6; font-size: 14px; max-height: 7.5em; overflow: auto; }
  .reason{ width:100%; min-height: 84px; border-radius: 12px; border:1px solid #ddd; padding:10px 12px; background: #fff; }
  .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top: 8px; }
  .pill{ padding:6px 10px; border-radius:999px; background: #fff; border:1px solid #eee; font-size: 13px; }

  .pager{ display:flex; gap:8px; align-items:center; margin-top: 16px; }
  .side{
    margin-top: 10px; padding: 12px; background:#ffffffaa; border:1px solid #eee; border-radius: var(--radius);
  }
  .side h3{ margin: 0 0 6px; font-size: 16px; }
  .small{ font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
<header>
  <h1>書籍推薦｜馬卡龍風</h1>
  <div class="bar">
    <input id="q" type="text" placeholder="關鍵字（例：intitle:閱讀 素養 或 author:幾米）">
    <button id="searchBtn">查詢</button>
    <span class="chip">每頁 2 本</span>
    <button id="saveAllBtn" title="把右側收藏清單上傳到雲端">收藏清單 → 上傳雲端</button>
    <button id="latestBtn" title="讀取試算表中的最新推薦">最新推薦</button>
    <select id="latestLimit">
      <option value="6" selected>最新 6 筆</option>
      <option value="10">最新 10 筆</option>
      <option value="20">最新 20 筆</option>
    </select>
  </div>
  <div id="status" class="notice" style="display:none"></div>
</header>

<div class="container">
  <div class="grid" id="grid"></div>

  <div class="pager" id="pager" style="display:none;">
    <button id="prevBtn">← 上一頁</button>
    <span id="pageInfo" class="pill"></span>
    <button id="nextBtn">下一頁 →</button>
  </div>

  <div class="side">
    <h3>我的收藏清單</h3>
    <div id="favList" class="small">尚未加入任何書籍</div>
  </div>
</div>

<script>
/** ======= 設定區 ======= **/
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwsctAFw7W41tkIsZWzG6bsMcf7yLWFJ5QK7oN5miGrpNoY9jdzkT0hvQX9SMFIJMoF/exec';
const USER_NAME = 'james su'; // 可替換成登入者名稱

/** ======= 小工具 ======= **/
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const qs = new URLSearchParams(location.search);
let viewingLatest = false; // 目前是否在看「最新推薦」
const sanitize = (s='') => (s+'').replace(/[<>]/g, m=>({ '<':'&lt;','>':'&gt;' }[m]));

/** ======= 狀態 ======= **/
let state = {
  items: [],    // 搜尋結果（正規化）
  page: 1,      // 每頁 2 本
  perPage: 2,
  favs: loadFavs() // 收藏清單（localStorage）
};

function loadFavs(){
  try{ return JSON.parse(localStorage.getItem('book_favs')||'[]'); }catch(e){ return []; }
}
function saveFavs(){
  localStorage.setItem('book_favs', JSON.stringify(state.favs));
  renderFavs();
}
function inFavs(isbn){ return state.favs.some(x => x.isbn === isbn); }

/** ======= API 查詢：Google Books → Open Library ======= **/
async function searchBooks(q, startIndex=0, maxResults=20){
  // Google Books
  try{
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&startIndex=${startIndex}&maxResults=${Math.min(40, maxResults)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('GB fail');
    const data = await res.json();
    if(!data.items?.length) throw new Error('no items');
    return data.items.map(pickFromGB);
  }catch(e){
    // Open Library
    const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&limit=${maxResults}`;
    const res = await fetch(url);
    if(!res.ok) return [];
    const data = await res.json();
    return (data.docs||[]).map(pickFromOLSearch);
  }
}

function pickFromGB(item){
  const v = item.volumeInfo || {};
  const isbn = v.industryIdentifiers?.find(x => (x.type||'').includes('ISBN'))?.identifier || '';
  return {
    id: item.id || isbn || (v.title||'')+(v.authors?.[0]||''),
    source: 'google_books',
    title: v.title || '',
    authors: v.authors || [],
    publisher: v.publisher || '',
    publishedDate: v.publishedDate || '',
    description: v.description || '',
    cover: v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || '',
    isbn
  };
}
function pickFromOLSearch(doc){
  const isbn = doc.isbn?.[0] || '';
  return {
    id: doc.key || isbn || (doc.title||''),
    source: 'open_library',
    title: doc.title || '',
    authors: doc.author_name || [],
    publisher: (doc.publisher && doc.publisher[0]) || '',
    publishedDate: doc.first_publish_year || '',
    description: doc.subtitle || '',
    cover: doc.cover_i ? `https://covers.openlibrary.org/b/id/${doc.cover_i}-M.jpg` : '',
    isbn
  };
}

// 從 GAS 讀取最新推薦
async function fetchLatest(limit=6){
  const url = `${GAS_ENDPOINT}?limit=${encodeURIComponent(limit)}`;
  const res = await fetch(url);
  const data = await res.json();
  if(!res.ok || !data.ok) throw new Error('讀取最新推薦失敗');
  const items = (data.items||[]).map(it => ({
    id: it.isbn || (it.title||'') + (it.authors||''),
    source: it.source || 'sheet',
    title: it.title || '',
    authors: Array.isArray(it.authors) ? it.authors : (it.authors ? String(it.authors).split(',').map(s=>s.trim()).filter(Boolean) : []),
    publisher: it.publisher || '',
    publishedDate: it.publishedDate || '',
    description: it.reason || '',
    cover: '',
    isbn: it.isbn || ''
  }));
  return items;
}

/** ======= 渲染（兩本一頁） ======= **/
function paginate(items){ // 2 本一頁
  const out = [];
  for(let i=0;i<items.length;i+=state.perPage){
    out.push(items.slice(i, i+state.perPage));
  }
  return out;
}

function render(){
  const pages = paginate(state.items);
  const pageCount = Math.max(pages.length, 1);
  const current = pages[state.page-1] || [];

  const grid = $('#grid');
  grid.innerHTML = '';

  current.forEach(book => grid.appendChild(renderCard(book)));

  // 分頁列
  const pager = $('#pager');
  $('#pageInfo').textContent = (viewingLatest ? '最新推薦｜' : '') + `第 ${state.page}/${pageCount} 頁（共 ${state.items.length} 本）`;
  pager.style.display = pageCount > 1 ? 'flex' : 'none';
  $('#prevBtn').disabled = state.page <= 1;
  $('#nextBtn').disabled = state.page >= pageCount;
}

function renderCard(book){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <img class="cover" alt="封面" src="${book.cover || ''}">
    <div>
      <h3 class="title">${sanitize(book.title) || '（無標題）'}</h3>
      <div class="meta">作者：${book.authors?.length ? sanitize(book.authors.join('、')) : '不詳'}</div>
      <div class="meta">出版：${[book.publisher, book.publishedDate].filter(Boolean).map(sanitize).join('，') || '—'}</div>
      <div class="desc">${sanitize(book.description || '（暫無介紹）').replace(/\n/g,'<br>')}</div>
      <div class="actions">
        <button class="favBtn">${inFavs(book.isbn) ? '✓ 已加入' : '加入收藏'}</button>
        <button class="uploadBtn" title="只上傳這一本到雲端">上傳到雲端</button>
        <span class="pill">${book.source === 'google_books' ? 'Google Books' : 'Open Library'}</span>
      </div>
      <label class="meta"><strong>推薦理由</strong></label>
      <textarea class="reason" placeholder="寫下你推薦這本書的原因"></textarea>
    </div>
  `;

  const reasonKey = `reason_${book.isbn || book.id}`;
  const reasonEl = card.querySelector('.reason');
  reasonEl.value = localStorage.getItem(reasonKey) || '';

  reasonEl.addEventListener('input', () => {
    localStorage.setItem(reasonKey, reasonEl.value);
    // 若在收藏清單裡，也同步更新理由
    const idx = state.favs.findIndex(x => x.isbn === book.isbn);
    if(idx !== -1){ state.favs[idx].reason = reasonEl.value; saveFavs(); }
  });

  // 加入收藏
  const favBtn = card.querySelector('.favBtn');
  favBtn.addEventListener('click', () => {
    if(inFavs(book.isbn)){
      state.favs = state.favs.filter(x => x.isbn !== book.isbn);
      favBtn.textContent = '加入收藏';
    }else{
      state.favs.push({
        isbn: book.isbn || '',
        title: book.title || '',
        authors: book.authors || [],
        publisher: book.publisher || '',
        publishedDate: book.publishedDate || '',
        reason: reasonEl.value || '',
        source: book.source || ''
      });
      favBtn.textContent = '✓ 已加入';
    }
    saveFavs();
  });

  // 單本上傳
  const uploadBtn = card.querySelector('.uploadBtn');
  uploadBtn.addEventListener('click', async () => {
    const payload = {
      user: USER_NAME,
      items: [{
        isbn: book.isbn || '',
        title: book.title || '',
        authors: book.authors || [],
        publisher: book.publisher || '',
        publishedDate: book.publishedDate || '',
        reason: reasonEl.value || '',
        source: book.source || ''
      }]
    };
    uploadBtn.disabled = true; uploadBtn.textContent = '上傳中…';
    const ok = await postToGAS(payload);
    uploadBtn.textContent = ok ? '已上傳 ✓' : '上傳失敗';
    setTimeout(() => { uploadBtn.disabled = false; uploadBtn.textContent = '上傳到雲端'; }, 2000);
  });

  return card;
}

/** ======= 收藏清單渲染 / 批次上傳 ======= **/
function renderFavs(){
  const box = $('#favList');
  if(!state.favs.length){ box.textContent = '尚未加入任何書籍'; return; }
  box.innerHTML = '';
  state.favs.forEach((b, i) => {
    const row = document.createElement('div');
    row.style.margin = '6px 0';
    row.innerHTML = `
      <span>${sanitize(b.title)} <span class="small">（${sanitize(b.isbn||'無ISBN')}）</span></span>
      <button data-i="${i}" class="rm" style="margin-left:8px;">移除</button>
    `;
    box.appendChild(row);
  });
  $$('.rm', box).forEach(btn => btn.addEventListener('click', (e)=>{
    const i = parseInt(e.target.dataset.i, 10);
    state.favs.splice(i, 1); saveFavs(); render();
  }));
}

async function uploadAllFavs(){
  if(!state.favs.length){ alert('收藏清單是空的'); return; }
  const payload = { user: USER_NAME, items: state.favs };
  $('#saveAllBtn').disabled = true; $('#saveAllBtn').textContent = '上傳中…';
  const ok = await postToGAS(payload);
  $('#saveAllBtn').textContent = ok ? '上傳完成 ✓' : '上傳失敗';
  setTimeout(()=>{ $('#saveAllBtn').disabled = false; $('#saveAllBtn').textContent = '收藏清單 → 上傳雲端'; }, 2000);
}

/** ======= 與 GAS 通訊 ======= **/
async function postToGAS(payload){
  // 兩種送法：
  // A) 預設使用 text/plain，避免瀏覽器預檢（OPTIONS）導致 CORS 問題
  // B) 若你確認可讀回應，將 USE_PLAIN = false 改回 application/json
  const USE_PLAIN = true;
  try{
    const fetchOptions = {
      method: 'POST',
      headers: USE_PLAIN ? { 'Content-Type': 'text/plain;charset=utf-8' } : { 'Content-Type': 'application/json' },
      body: USE_PLAIN ? JSON.stringify(payload) : JSON.stringify(payload)
    };
    const res = await fetch(GAS_ENDPOINT, fetchOptions);

    // 嘗試讀取文字並轉 JSON（若跨網域受限，至少可看到狀態碼）
    const text = await res.text();
    let data = {};
    try{ data = JSON.parse(text); }catch(e){ /* 不是 JSON 也沒關係 */ }

    // 在畫面上顯示詳細錯誤訊息（方便除錯）
    const statusBox = document.querySelector('#status');
    if(statusBox){
      statusBox.style.display = 'block';
      statusBox.textContent = `WebApp 回應狀態：${res.status} ${res.statusText}` + (text ? `｜內容：${text.slice(0,200)}` : '');
    }

    return res.ok && (data.ok === true || text.includes('"ok":true'));
  }catch(e){
    console.error(e);
    const statusBox = document.querySelector('#status');
    if(statusBox){
      statusBox.style.display = 'block';
      statusBox.textContent = '連線發生錯誤：' + String(e);
    }
    return false;
  }
}

/** ======= 互動 ======= **/
async function handleSearch(){
  viewingLatest = false; // 回到搜尋模式
  const q = $('#q').value.trim();
  if(!q){ alert('請輸入關鍵字'); return; }
  $('#status').style.display = 'block'; $('#status').textContent = '查詢中…';
  try{
    const items = await searchBooks(q, 0, 20);
    state.items = items;
    state.page = 1;
    $('#status').style.display = 'none';
    render(); // 兩本一頁
  }catch(e){
    $('#status').textContent = '查詢失敗，請稍後再試';
  }
}

$('#searchBtn').addEventListener('click', handleSearch);
$('#q').addEventListener('keydown', e => { if(e.key==='Enter') handleSearch(); });
$('#prevBtn').addEventListener('click', ()=>{ if(state.page>1){ state.page--; render(); }});
$('#nextBtn').addEventListener('click', ()=>{
  const pages = Math.max(Math.ceil(state.items.length/state.perPage), 1);
  if(state.page<pages){ state.page++; render(); }
});
$('#saveAllBtn').addEventListener('click', uploadAllFavs);
$('#latestBtn').addEventListener('click', async ()=>{
  try{
    $('#status').style.display='block'; $('#status').textContent='讀取最新推薦中…';
    const limit = parseInt($('#latestLimit').value,10) || 6;
    const items = await fetchLatest(limit);
    viewingLatest = true;
    state.items = items;
    state.page = 1;
    $('#status').style.display='none';
    render();
  }catch(e){
    $('#status').style.display='block'; $('#status').textContent='讀取最新推薦失敗';
  }
});

renderFavs(); // 初始化收藏清單
// URL 若有 q 參數就自動查
if(qs.get('q')){ $('#q').value = qs.get('q'); handleSearch(); }
</script>
</body>
</html>
